#!/bin/sh
# start wmiiwm and wait for its termination

wmiiwm -c || exit 1

WMII_CONFPATH="$HOME/.wmii-4:CONFPREFIX/wmii-4" export WMII_CONFPATH
WMII_NS_DIR="/tmp/ns.$USER.${DISPLAY%.0}" export WMII_NS_DIR
WMII_ADDRESS="unix!$WMII_NS_DIR/wmii" export WMII_ADDRESS

# Make sure that the namespace directory exists and has correct permissions
mkdir -m 700 "$WMII_NS_DIR" 2>/dev/null ||
if ls -ld "$WMII_NS_DIR" |
   awk -v "user=`id -un`" \
        '{ if ($3 == user && match($1,"^drwx-----"))
              exit 1 }'
then
	echo "The socket directory \"$WMII_NS_DIR\" " \
	     "is group or world writable " \
	     "or is not owned by you" 1>&2
	exit 1
fi

wmiiwm -a $WMII_ADDRESS &
wmiiwmpid=$!
mkdir $HOME/.wmii-4 2>/dev/null && welcome &
`PATH="$WMII_CONFPATH:$PATH" which wmiirc` &
wait $wmiiwmpid
