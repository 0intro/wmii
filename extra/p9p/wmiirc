#!/usr/local/plan9/bin/rc
# configure wmii
PIDFILE=/tmp/ns.$USER.$DISPLAY/`{basename $0}^'pid'
fn xwrite {a=$1; shift; echo -n $* | wmiir write $a}

if(test -r $PIDFILE)
	kill `{cat $PIDFILE}
if(~ stop $1) exit
echo $pid >$PIDFILE

MODKEY=Alt
WMII_FONT='fixed'
WMII_NORMCOLORS='#222222 #eeeeee #666666'
WMII_SELCOLORS='#ffffff #285577 #4c7899'

# WM CONFIGURATION
xwrite /def/border 3
xwrite /def/snap 20
xwrite /def/font $WMII_FONT
xwrite /def/selcolors $WMII_SELCOLORS
xwrite /def/normcolors $WMII_NORMCOLORS
xwrite /ws/tag 1

# TAGGING RULES
wmiir write /def/rules <<END
/XMMS:.*/ -> ~0
/Gimp.*:.*/ -> ~3
END

# BAR CONFIGURATION
wmiir create /bar/foo
xwrite /bar/foo/colors $WMII_SELCOLORS
xwrite /bar/expand foo

# MENU CONFIGURATION
fn items {ls -lpL $* | awk '!/^d/ && $1 ~ /x/ {print $NF}'| sort | uniq}
items `{echo $OLD_PATH | sed 's/:/ /g'} >/tmp/ns.$USER.$DISPLAY/p.menu &

# MISC
xsetroot -solid '#0b1014'
status &

# KEYS CONFIGURATION
for(i in \
	$MODKEY-^(t Return space h l j k Tab m s e n `{seq 0 9}) \
	$MODKEY-Shift-^(Return space `{seq 0 9}) \
	$MODKEY-Control-^(c w,y q,y p a)) \
    	echo -n | wmiir create /def/$i

# EVENT LOOP
oldt=''
wmiir read /event| 
while(e=`{read}) {
	switch($e(1)) {
	case NT
		t=$e(2)
		wmiir create /bar/$t
		if(~ $t $olt)
			xwrite /bar/$"t/colors $WMII_NORMCOLORS
		if not
			xwrite /bar/$"t/colors $WMII_SELCOLORS
		xwrite /bar/$"t/data $e(2)
	case RT
		wmiir remove /bar/$e(2)
	case TF
		t=$e(2)
		if (! ~ $#oldt 0)
			xwrite /bar/$oldt/colors $WMII_SELCOLORS
		xwrite /bar/$t/data $e(2)
		xwrite /bar/$t/colors $WMII_NORMCOLORS
		oldt=$e(2)
	case LB
		xwrite /ctl select $e(2)
	case K
		switch($e(2)) {
		case $MODKEY-Control-c
			xwrite /ws/sel/sel/ctl kill
		case $MODKEY-Control-w,y
			wmiirc&
		case $MODKEY-Control-q,y
			xwrite /ctl quit
		case $MODKEY-Control-p
			extern `{wmiimenu < /tmp/ns.$USER.$DISPLAY/p.menu}&
		case $MODKEY-Control-a
			`{items /usr/local/etc/wmii-3 $HOME/.wmii-3 | wmiimenu}&
		case $MODKEY-t
			extern xterm&
		case $MODKEY-m
	                xwrite /ws/sel/mode max
	        case $MODKEY-s
                        xwrite /ws/sel/mode stack
               	case $MODKEY-e
	                xwrite /ws/sel/mode equal
                case $MODKEY-n
               	        xwrite /ws/sel/sel/ctl sendto new
                case $MODKEY-Return
	               xwrite /ws/sel/sel/ctl sendto prev
		case $MODKEY-Shift-Return
                        xwrite /ws/sel/sel/ctl sendto next
		case $MODKEY-space
			xwrite /ws/sel/sel/ctl sendto 0
		case $MODKEY-Shift-space
                        xwrite /ws/sel/sel/ctl sendto 1
	        case $MODKEY-h
                        xwrite /ws/ctl select prev
	        case $MODKEY-l
			xwrite /ws/ctl select next
		case $MODKEY-Tab
			xwrite /ws/sel/ctl select next
		case $MODKEY-j
        	                xwrite /ws/sel/ctl select next
		case $MODKEY-k
                        xwrite /ws/sel/ctl select prev
		case $MODKEY-[0-9]
                        xwrite /ctl `{echo $e | awk -F- '{print "select "$2}'}

		case $MODKEY-Shift-Return
			xwrite /ws/sel/sel/ctl sendto next
		case $MODKEY-Shift-space
			xwrite /ws/sel/sel/ctl sendto 1
		case $MODKEY-Shift-[0-9]
                        xwrite /ws/sel/sel/tags ' '`{echo $e | awk -F- '{print $3}'}
		}
	}
} &
echo $apid >$PIDFILE
